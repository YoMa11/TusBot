# ---- Shell ----
SHELL := /bin/bash

# ---- Config ----
PROJECT_NAME ?= tustus_bot_inline_PRO
PY           ?= python3
VENV         ?= .venv
PIP          ?= $(VENV)/bin/pip
PYBIN        ?= $(VENV)/bin/python
RELEASE_SH   ?= releases.sh   # × ×©×ª××© ×‘×• ×›×‘×¨×™×¨×ª ××—×“×œ; × ×™×¤×•×œ ×œ-release.sh ×× ×¦×¨×™×š

# --- configurable defaults (×ª×•×× releases.sh) ---
CHMOD        ?=
# ××œ ×ª×›×œ×•×œ DB ×‘×‘×¨×™×¨×ª ××—×“×œ (× ×™×ª×Ÿ ×œ×”×—×œ×™×£ ×œ-INCLUDE_DB=1 ×‘×¤×§×•×“×”)
INCLUDE_DB   ?= 0
# bump kind: patch|minor|major (default patch)
BUMP         ?= patch
# ×©××™×¨×ª stage? 0=no (default), 1=yes
KEEP         ?= 0
# space-separated patterns to exclude from the release package (××™×“×¢ ×‘×œ×‘×“; ×”×”×—×¨×’×•×ª ×‘×¤×•×¢×œ × ×¢×©×•×ª ×‘×¡×§×¨×™×¤×˜)
EXCLUDE_PATTERNS ?= old/ *.zip .venv/ __pycache__/ .DS_Store *.pyc bot.log bot.err.log _debug_* .pytest_cache .mypy_cache .ruff_cache

#file location 
OUT_DIR ?= /Users/yossimantsour/Desktop/tusbot

# ---- Targets ----
.PHONY: help venv install install-jobqueue install-scrape run start stop scrape \
        release release-major release-minor release-patch release-set version \
        rmaj rmin rpatch rdb clean

help:
	@echo "Targets:"
	@echo "  make venv                  # ×™×•×¦×¨ ×¡×‘×™×‘×” ×•×™×¨×˜×•××œ×™×ª"
	@echo "  make install               # ××ª×§×™×Ÿ ×ª×œ×•×ª×™× ×-requirements.txt"
	@echo "  make install-jobqueue      # ××ª×§×™×Ÿ python-telegram-bot[job-queue]"
	@echo "  make install-scrape        # ××ª×§×™×Ÿ ×—×‘×™×œ×•×ª ×¢×‘×•×¨ ×¨×™× ×“×•×¨ JS (requests-html, lxml_html_clean)"
	@echo "  make run                   # ××¨×™×¥ ××ª ×”×‘×•×˜ (××¢×“×™×£ botctl.sh, ××—×¨×ª app.py)"
	@echo "  make start / make stop     # ×”×¤×¢×œ×”/×›×™×‘×•×™ ×“×¨×š botctl.sh (×× ×§×™×™×)"
	@echo "  make scrape                # ×¨×™×¦×ª ×“×™×‘×•×’ ×¡×§×¨×™×™×¤×¨ (debug_scrape_once.py)"
	@echo "  make version               # ××¦×™×’ ×’×¨×¡×ª ×¤×¨×•×™×™×§×˜ ×¢×›×©×•×•×™×ª (×-VERSION/ZIP)"
	@echo "  make release               # ×™×•×¦×¨ ZIP ×¢× ×’×¨×¡×” ×—×“×©×” (×‘×¨×™×¨×ª ××—×“×œ: patch)"
	@echo "     ×¤×¨××˜×¨×™×: BUMP=major|minor|patch (default patch), INCLUDE_DB=0|1, CHMOD=777, KEEP=1"
	@echo "  make release-major         # ××¢×œ×” ×’×¨×¡×ª Major"
	@echo "  make release-minor         # ××¢×œ×” ×’×¨×¡×ª Minor"
	@echo "  make release-patch         # ××¢×œ×” ×’×¨×¡×ª Patch"
	@echo "  make release-set VERSION=X.Y.Z  # ×§×•×‘×¢ ×’×¨×¡×” ×™×“× ×™×ª"
	@echo "  make clean                 # × ×™×§×•×™ ×§×‘×¦×™ ×‘×™× ×™×™×"

venv:
	@test -d $(VENV) || $(PY) -m venv $(VENV)
	@echo "âœ… venv ready: $(VENV)"

install: venv
	$(PIP) install --upgrade pip
	@test -f requirements.txt && $(PIP) install -r requirements.txt || echo "â„¹ï¸ no requirements.txt"

install-jobqueue: venv
	$(PIP) install 'python-telegram-bot[job-queue]'

install-scrape: venv
	$(PIP) install requests-html 'lxml[html_clean]' lxml_html_clean || true

# ---- Run helpers ----
run: venv
	@if [[ -x ./botctl.sh ]]; then \
		chmod +x ./botctl.sh; \
		./botctl.sh run; \
	elif [[ -f app.py ]]; then \
		$(PYBIN) app.py; \
	else \
		echo "âŒ no botctl.sh or app.py found"; exit 1; \
	fi

start: venv
	@if [[ -x ./botctl.sh ]]; then \
		chmod +x ./botctl.sh; ./botctl.sh start; \
	else echo "âŒ botctl.sh not found or not executable"; exit 1; fi

stop:
	@if [[ -x ./botctl.sh ]]; then \
		chmod +x ./botctl.sh; ./botctl.sh stop; \
	else echo "âŒ botctl.sh not found or not executable"; exit 1; fi

scrape: venv
	@if [[ -f debug_scrape_once.py ]]; then \
		$(PYBIN) debug_scrape_once.py; \
	else \
		echo "âŒ debug_scrape_once.py not found"; exit 1; \
	fi

version:
	@ver=""; \
	if [[ -f VERSION ]]; then ver=$$(tr -d '\n' < VERSION); \
	elif ls -1 $(PROJECT_NAME)_v*.zip >/dev/null 2>&1; then \
	  ver=$$(ls -1 $(PROJECT_NAME)_v*.zip | \
	    sed -E 's/.*_v([0-9]+\.[0-9]+\.[0-9]+)\.zip/\1 \0/' | sort -V | tail -n1 | awk '{print $$1}'); \
	fi; \
	if [[ -n "$$ver" ]]; then \
	  echo "ğŸ“¦ version: $$ver"; \
	else \
	  echo "â„¹ï¸ version: unknown"; fi

# ---- Release flows (wraps releases.sh / release.sh) ----
# ×‘×•×—×¨ ××•×˜×•××˜×™×ª releases.sh; ×× ×œ× ×§×™×™×, × ×•×¤×œ ×œ-release.sh
_define_release = \
	script=""; \
	if [[ -x ./$(RELEASE_SH) ]]; then script=./$(RELEASE_SH); \
	elif [[ -x ./release.sh ]]; then script=./release.sh; \
	else echo "âŒ releases.sh/release.sh not found"; exit 1; fi; \
	chmod +x $$script; \
	BUMP=$(BUMP) INCLUDE_DB=$(INCLUDE_DB) CHMOD=$(CHMOD) KEEP=$(KEEP) $$script $(1)


release:
	@chmod +x ./release.sh
	@BUMP=$(if $(BUMP),$(BUMP),patch) INCLUDE_DB=$(if $(INCLUDE_DB),$(INCLUDE_DB),0) CHMOD=$(CHMOD) OUT_DIR=$(OUT_DIR) ./release.sh

release-major:
	@chmod +x ./release.sh
	@BUMP=major INCLUDE_DB=$(if $(INCLUDE_DB),$(INCLUDE_DB),0) CHMOD=$(CHMOD) OUT_DIR=$(OUT_DIR) ./release.sh

release-minor:
	@chmod +x ./release.sh
	@BUMP=minor INCLUDE_DB=$(if $(INCLUDE_DB),$(INCLUDE_DB),0) CHMOD=$(CHMOD) OUT_DIR=$(OUT_DIR) ./release.sh

release-patch:
	@chmod +x ./release.sh
	@BUMP=patch INCLUDE_DB=$(if $(INCLUDE_DB),$(INCLUDE_DB),0) CHMOD=$(CHMOD) OUT_DIR=$(OUT_DIR) ./release.sh

release-set:
	@test -n "$(VERSION)" || (echo "âŒ Missing VERSION=X.Y.Z"; exit 1)
	@chmod +x ./release.sh
	@OUT_DIR=$(OUT_DIR) ./release.sh --set $(VERSION)


# ×§×™×¦×•×¨×™×
rmaj:   ; @$(MAKE) release BUMP=major
rmin:   ; @$(MAKE) release BUMP=minor
rpatch: ; @$(MAKE) release BUMP=patch
rdb:    ; @$(MAKE) release INCLUDE_DB=1

clean:
	@find . -name "__pycache__" -type d -prune -exec rm -rf {} +
	@find . -name ".pytest_cache" -type d -prune -exec rm -rf {} +
	@rm -rf *.egg-info
	@echo "ğŸ§¹ clean done"
