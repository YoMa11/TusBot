# handlers.py
from __future__ import annotations

from dataclasses import dataclass, field
from typing import Iterable, List, Optional, Tuple

from telegram import Update, InlineKeyboardMarkup, InlineKeyboardButton
from telegram.ext import ContextTypes

# ××•×“×•×œ×™× ×¤× ×™××™×™×
import config  # ×œ× ××©× ×” ×›×œ×•× ×‘×§×•×‘×¥ ×”×–×”, ×¨×§ ×§×•×¨× ××× ×• ×’×¨×¡×”/× ×ª×™×‘ DB ×× ×¦×¨×™×š
import db
import logic


# ========= ××¦×‘ ×‘×—×™×¨×” =========

@dataclass
class SelectedState:
    """××¦×‘ ×‘×—×™×¨×ª ×”××©×ª××© ×¢×œ ××¡×š ×”×‘×™×ª (×™×¢×“×™× ×•×›×•'). × ×©××¨ ×‘-user_data."""
    destinations: List[str] = field(default_factory=list)

    @classmethod
    def from_context(cls, context: ContextTypes.DEFAULT_TYPE) -> "SelectedState":
        raw = context.user_data.get("selected_state")
        if isinstance(raw, dict):
            return cls(destinations=list(raw.get("destinations", [])))
        if isinstance(raw, SelectedState):
            return raw
        return cls()

    def save(self, context: ContextTypes.DEFAULT_TYPE) -> None:
        context.user_data["selected_state"] = {"destinations": list(self.destinations)}


# ========= Utilities =========

def _safe_get_conn():
    """
    ×¢×˜×™×¤×” ×©×ª×•××›×ª ×’× ×‘-db.get_conn() ×œ×œ× ×¤×¨××˜×¨ ×•×’× ×‘-db.get_conn(path).
    ×œ× × ×•×’×¢×ª ×‘××™××•×© ××¦×œ×š â€“ ×¨×§ ×× ×¡×” ××ª ×©×ª×™ ×”××¤×©×¨×•×™×•×ª.
    """
    try:
        return db.get_conn()  # ×¡×•×’ ××™××•×© ××—×“ ×©×™×© ××¦×œ×š
    except TypeError:
        # ××™××•×© ×™×©×Ÿ/××—×¨ â€“ × ×§×— × ×ª×™×‘ ××”-config ×× ×™×©
        return db.get_conn(getattr(config, "DB_PATH", "./flights.db"))


def _greeting_line(version: str) -> str:
    """
    ×›×•×ª×¨×ª ×¤×ª×™×—×” ×”×•××•×¨×™×¡×˜×™×ª + ×’×¨×¡×”. ××©×ª× ×” ×§×œ×•×ª ×œ×¤×™ ×”×©×¢×” (×›×œ ×©×¢×ª×™×™×).
    ×œ×¤×™ ×‘×§×©×ª×š â€“ ×‘×©×•×¨×ª ×”×›×•×ª×¨×ª ××•×¤×™×¢×” ×¨×§ ×‘×¨×›×” + ×’×¨×¡×”, ×‘×œ×™ ×©×•× ×˜×™×¡×•×ª/×¡×™×›×•××™×.
    """
    import datetime as _dt

    jokes = [
        "ğŸš€â˜•ï¸ ×ª×¤×¡× ×• ×¢×•×“ ×“×™×œ ×©×××¨×™× ××”×¨ ×™×•×ª×¨ ××”×§×¤×” ×©×œ ×”×‘×•×§×¨.",
        "ğŸ›«ğŸ§  ××œ×’×•×¨×™×ª× ×¢×œ ×¡×˜×¨×•××™×“×™×, ××—×¤×© ×˜×™×¡×•×ª ×‘×–××Ÿ ×©××ª×” ×©×•×ª×” ××™×.",
        "âœˆï¸ğŸ© ×× ×™×© ×—×•×¨ ×‘×–×× ×™×, ×× ×—× ×• × ×•×—×ª×™× ×“×¨×›×• ×œ×“×™×œ.",
        "ğŸ§³âš¡ï¸ ×”×‘×•×˜ ×¢×œ ×˜×•×¨×‘×• â€“ ×ª×–×”×¨ ×©×œ× ×ª×ª×¢×•×¤×£ ××”×¡×¤×”.",
        "ğŸŒğŸ” ×–×” ×œ× ×§×¡×, ×–×” SQL + ×§×¦×ª ×—×•×¦×¤×” ×™×©×¨××œ×™×ª.",
        "ğŸ›¬ğŸ§­ ××¦×× ×• ××¡×œ×•×œ ×§×¦×¨ ×™×•×ª×¨ ×œ××‘×¦×¢. ×ª×‘×“×•×§ ××•×ª× ×•.",
    ]
    slot = (_dt.datetime.now().hour // 2) % len(jokes)
    return f"{jokes[slot]}\nvtustus_{version}\u2063"  # \u2063 ×œ×× ×™×¢×ª 'Message is not modified'


def _get_version() -> str:
    """×× ×¡×” ×œ×”×‘×™× ×’×¨×¡×” ×-logic.get_version(), ×× ××™×Ÿ â€“ × ×•×¤×œ ×œ-config.SCRIPT_VERSION ××• ×œ×’×¨×¡×” ××ª×•×š ×”×§×•×‘×¥."""
    try:
        return logic.get_version()  # ×× ×§×™×™× ××¦×œ×š
    except Exception:
        return getattr(config, "SCRIPT_VERSION", getattr(config, "__file_version__", "V2.0"))


# ========= ×‘×œ×•×§ ×”×™×¢×“×™× =========

def _build_dest_block(conn, selected: SelectedState) -> InlineKeyboardMarkup:
    """
    ×¨×©×™××ª ×™×¢×“×™×: ×¢×™×¨ + ×“×’×œ ××“×™× ×” (×œ×œ× ××—×™×¨ ×•×œ×œ× ×©× ×”××“×™× ×”).
    ×›×•×œ×œ '×›×œ ×”×™×¢×“×™×', '× ×§×” ×‘×—×™×¨×•×ª'. ×©×ª×™ ×¢××•×“×•×ª.
    """
    rows: Iterable[Tuple[str, str, object]] = logic.list_all_destinations_with_country(conn)
    # rows ×××•×¨×•×ª ×œ×”×—×–×™×¨ (city, country, â€¦). ×× ×—× ×• × ×©×ª××© ×¨×§ ×‘-2 ×”×¨××©×•× ×™×.
    buttons: List[InlineKeyboardButton] = []

    # ×›×œ ×”×™×¢×“×™×
    buttons.append(InlineKeyboardButton("ğŸŒ ×›×œ ×”×™×¢×“×™×", callback_data="dst:__ALL__"))

    # ××™×¡×•×£ ×œ×•×’×™ ×œ×§×™×‘×•×¥ ×œ×¤×™ ××“×™× ×” (×›×“×™ ×©×™×™×©×‘×• ×¦××•×“)
    # {country: [city, city, ...]}
    by_country: dict[str, List[str]] = {}
    for row in rows:
        # row ×™×›×•×œ ×œ×”×™×•×ª (city, country) ××• (city, country, X)
        if not isinstance(row, (tuple, list)) or len(row) < 2:
            # ×“×œ×’ ×× ×©×•×¨×” ×œ× ×ª×§×™× ×”
            continue
        city = (row[0] or "").strip()
        country = (row[1] or "").strip()
        if not city:
            continue
        by_country.setdefault(country, []).append(city)

    # ××™×•×Ÿ ×œ×¤×™ ××“×™× ×” ×•××– ×œ×¤×™ ×¢×™×¨
    for country in sorted(by_country.keys(), key=lambda s: (s or "zzz").lower()):
        flag = ""
        try:
            flag = logic.country_to_flag(country or "")
        except Exception:
            flag = ""
        for city in sorted(by_country[country], key=lambda s: s.lower()):
            label = f"{flag} {city}".strip()
            if city in (selected.destinations or []):
                label = f"âœ… {label}"
            buttons.append(InlineKeyboardButton(label[:60], callback_data=f"dst:{city}"))

    # ×©×ª×™ ×¢××•×“×•×ª
    keyboard = [buttons[i:i + 2] for i in range(0, len(buttons), 2)]
    # ×ª×—×ª×™×ª ×¤×¢×•×œ×•×ª
    keyboard.append([
        InlineKeyboardButton("ğŸ—‘ï¸ × ×§×” ×‘×—×™×¨×•×ª", callback_data="dst:__CLEAR__"),
        InlineKeyboardButton("×¨×¢× ×•×Ÿ ğŸ”„", callback_data="refresh"),
    ])
    keyboard.append([
        InlineKeyboardButton("×¡×™×›×•× ×™×¢×“×™× ğŸ“Š", callback_data="sum"),
    ])
    return InlineKeyboardMarkup(keyboard)


# ========= ××¡×š ×¨××©×™ =========

def _build_main_screen(conn, selected: SelectedState) -> tuple[str, InlineKeyboardMarkup]:
    """×”××¡×š ×”×¨××©×™: ×¨×§ ×›×•×ª×¨×ª ×¤×ª×™×—×” + ×‘×œ×•×§ ×”×™×¢×“×™× (×¢×™×¨ + ×“×’×œ)."""
    greet = _greeting_line(version=_get_version())
    km = _build_dest_block(conn, selected)
    return greet, km


# ========= Handlers =========

async def handle_start(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    conn = _safe_get_conn()
    if conn is None:
        await update.effective_message.reply_text("DB ×œ× ××—×•×‘×¨.")
        return

    selected = SelectedState.from_context(context)
    text, km = _build_main_screen(conn, selected)
    await update.effective_message.reply_text(text, reply_markup=km)


async def handle_callback(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    q = update.callback_query
    await q.answer()
    data = (q.data or "").strip()

    conn = _safe_get_conn()
    if conn is None:
        await q.edit_message_text("DB ×œ× ××—×•×‘×¨.")
        return

    selected = SelectedState.from_context(context)

    if data == "refresh" or data == "home":
        text, km = _build_main_screen(conn, selected)
        # ×× ×™×¢×ª "Message is not modified"
        old_text = q.message.text or ""
        old_km = q.message.reply_markup
        if old_text == text and str(old_km) == str(km):
            text += "\u2063"
        await q.edit_message_text(text, reply_markup=km)
        return

    if data == "sum":
        # ×›××Ÿ ×¨×§ ××¦×™×’×™× ×”×•×“×¢×” ×–×× ×™×ª. ×œ×•×’×™×§×ª ×¡×™×›×•× ××œ××” â€“ ×‘×§×‘×¦×™× ×”×¨×œ×•×•× ×˜×™×™× ××¦×œ×š.
        # ××™×Ÿ ×©×™× ×•×™×™ DB/logic â€“ ××©××™×¨ ×›×¤×™ ×©×¡×™×›×× ×•.
        text = "ğŸ“Š ×¡×™×›×•× ×™×¢×“×™× â€“ ×™×’×™×¢ ×‘×¢×“×›×•×Ÿ ×”×‘× (×œ×œ× ×©×™× ×•×™×™ ×¡×›×™××”)."
        # ×œ×”×©××™×¨ ××ª ××•×ª×• ××§×œ×“×ª
        _, km = _build_main_screen(conn, selected)
        old_text = q.message.text or ""
        old_km = q.message.reply_markup
        if old_text == text and str(old_km) == str(km):
            text += "\u2063"
        await q.edit_message_text(text, reply_markup=km)
        return

    if data.startswith("dst:"):
        arg = data[4:]
        if arg == "__ALL__":
            # ×‘×—×™×¨×ª ×›×œ ×”×™×¢×“×™×
            try:
                rows = logic.list_all_destinations_with_country(conn)
            except Exception:
                rows = []
            all_cities: List[str] = []
            for row in rows:
                if isinstance(row, (tuple, list)) and len(row) >= 1:
                    city = (row[0] or "").strip()
                    if city:
                        all_cities.append(city)
            selected.destinations = sorted(set(all_cities))
        elif arg == "__CLEAR__":
            selected.destinations.clear()
        else:
            # toggle ×œ×¢×™×¨ ×¡×¤×¦×™×¤×™×ª
            city = arg.strip()
            if city:
                if city in selected.destinations:
                    selected.destinations.remove(city)
                else:
                    selected.destinations.append(city)
        selected.save(context)

        text, km = _build_main_screen(conn, selected)
        old_text = q.message.text or ""
        old_km = q.message.reply_markup
        if old_text == text and str(old_km) == str(km):
            text += "\u2063"
        await q.edit_message_text(text, reply_markup=km)
        return

    # ×‘×¨×™×¨×ª ××—×“×œ â€“ ×—×–×¨×” ×œ××¡×š ×¨××©×™
    text, km = _build_main_screen(conn, selected)
    old_text = q.message.text or ""
    old_km = q.message.reply_markup
    if old_text == text and str(old_km) == str(km):
        text += "\u2063"
    await q.edit_message_text(text, reply_markup=km)
