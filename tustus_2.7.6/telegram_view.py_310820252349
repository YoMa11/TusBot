from __future__ import annotations
import datetime as dt
from typing import Optional, Dict

def format_greeting(now: Optional[dt.datetime] = None) -> str:
    """
    ×‘×¨×›×” ×”×•××•×¨×™×¡×˜×™×ª/×¡×¨×§×¡×˜×™×ª ×©××©×ª× ×” ×›×œ ×©×¢×ª×™×™×.
    """
    if now is None:
        now = dt.datetime.now()
    jokes = [
        "ğŸ‘‹ ×”×™×™, ×–×” ×˜×•×¡Ö¾×˜×•×¡. ×§×¤×” ×œ××•×¨×š ×”××¡×œ×•×œ ×¢×œ×™×š.",
        "ğŸ¤– ×”×ª×§× ×ª×™ ×˜×•×¨×‘×•. ×× ××™×Ÿ ××‘×¦×¢ â€“ ×× ×™ ××•×¦× ×”× ×—×” ×œ×›×¨×™×š.",
        "ğŸ›« ××•×›×Ÿ ×œ×”××¨××”. ××§×•×•×” ×©×”××¨× ×§ × ×©××¨ ×¢×œ ××¦×‘ ×˜×™×¡×”.",
        "ğŸ¯ ××¦××ª×™ ×™×¢×“×™× ×—××™×. ×ª×‘×—×¨ ×œ×¤× ×™ ×©×™×©×‘×• ×¢×œ×™×”×.",
        "ğŸŒ ×”×™×•× ×˜×¡×™× ×¨×—×•×§â€¦ ××• ×§×¨×•×‘. ×ª×œ×•×™ ×‘×ª×§×¦×™×‘ ğŸ˜…",
        "ğŸ§³ ××¨×–×ª×™ ×‘×©×‘×™×œ×š: ×™×¢×“×™×, ××—×™×¨×™×, ×•×ª×§×•×•×” ×œ××•×©×‘ ×¨×™×§.",
    ]
    idx = ((now.hour // 2) + now.day) % len(jokes)
    return jokes[idx]

def format_price(currency: Optional[str], price: Optional[float], fallback: Optional[str] = None) -> str:
    """
    ××¦×™×’ ××—×™×¨ ×™×¤×”. ×× ××™×Ÿ price/currency â€“ ××©×ª××© ×‘-fallback ××˜×§×¡×˜ ×’×•×œ××™.
    """
    if price and currency:
        try:
            # ×”×¦×’×” ×œ×œ× ×”××¨×” â€“ ×›×¤×™ ×©×‘×™×§×©×ª
            val = int(price) if float(price).is_integer() else round(float(price), 2)
        except Exception:
            return fallback or ""
        return f"{currency}{val}"
    return fallback or ""

def summarize_selection(s: Dict[str, object]) -> str:
    """
    ×©×•×¨×ª ×ª×§×¦×™×¨ ×‘×—×™×¨×•×ª ×”××©×ª××© â€“ ×™×¢×“, ×ª××¨×™×š, ××•×©×‘×™×, × ×¨××•×ª.
    """
    dst = "×›×œ ×”×™×¢×“×™×" if s.get("dst_all", True) else f"{s.get('dst_city','')} Â· {s.get('dst_country','')}"
    mode = s.get("date_mode", "none")
    if mode == "exact" and s.get("date_exact"):
        d = str(s["date_exact"])
        date_str = dt.datetime.fromisoformat(d).strftime("%d/%m/%Y")
        date_disp = f"××“×•×™×§ {date_str}"
    elif mode == "plusminus" and s.get("date_exact"):
        d = str(s["date_exact"])
        date_str = dt.datetime.fromisoformat(d).strftime("%d/%m/%Y")
        date_disp = f"Â±3 ×™××™× ×¡×‘×™×‘ {date_str}"
    else:
        date_disp = "×œ×œ× ×ª××¨×™×š"

    seats = int(s.get("seats_min", 1))
    vis = {"new":"×—×“×©×•×ª", "active":"×§×™×™××•×ª", "gone":"×™×¨×“×•"}.get(str(s.get("visibility","active")), "×§×™×™××•×ª")
    return f"\n×‘×—×™×¨×”: ×™×¢×“ â€“ {dst} | ×ª××¨×™×š â€“ {date_disp} | ××•×©×‘×™× ××™× ' â€“ {seats} | × ×¨××•×ª â€“ {vis}"
