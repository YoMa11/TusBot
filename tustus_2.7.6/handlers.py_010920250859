from __future__ import annotations
from typing import List, Tuple, Optional, Set
from telegram import Update, InlineKeyboardMarkup, InlineKeyboardButton
from telegram.ext import ContextTypes
import time

import db
import logic

# =========================
# ××¦×‘×™ ××©×ª××© (user_data)
# =========================
# × ×©××•×¨ ×¡×˜ ×©×œ ×™×¢×“×™× ×©× ×‘×—×¨×• ×‘×¤×•×¨××˜ "City|Country"
UKEY_SELECTED_DESTS = "selected_dests"

# =========================
# ×‘×¨×›×” ×”×•××•×¨×™×¡×˜×™×ª ××ª×—×œ×¤×ª
# =========================
def _greeting_line(version: str = "") -> str:
    jokes = [
        "×”×™×™, ×–×” ×˜×•Ö¾×¡×˜×•×¡. ×§×¤×” ×œ××¨×•×š ×”××¡×œ×•×œ ×¢×œ×™×š â˜•ï¸",
        "××”×œ×Ÿ! ×× ×”××—×™×¨ × ××•×š ××“×™â€”×–×” ×œ× ×‘××’, ×–×” ××•×¤×™ ğŸ˜",
        "×‘×¨×•×š ×”×‘×! ×× ×—× ×• ×¢×•×§×‘×™× ××—×¨×™ ××‘×¦×¢×™× ×™×•×ª×¨ ××”×¨ ××©×”×—×•×¤×©×” × ×’××¨×ª ğŸƒâ€â™‚ï¸ğŸ’¨",
        "×©×œ×•×! ××‘×¦×¢ ×˜×•×‘ ×™×•×ª×¨ ×××—×™×¨×™ duty free? ×œ×¤×¢××™× ××¤×™×œ×• ×›×Ÿ ğŸ",
    ]
    # ××ª×—×œ×£ ×›×œ ×©×¢×ª×™×™×
    idx = (int(time.time()) // (60 * 60 * 2)) % len(jokes)
    base = jokes[idx]
    if version:
        base += f" Â· v{version}"
    return base

# =========================
# ×‘× ×™×™×ª ×‘×œ×•×§ ×”×™×¢×“×™×
# =========================
def _fetch_dest_rows(conn) -> List[Tuple[str, str, str, Optional[float]]]:
    """
    ××—×–×™×¨ ×¨×©×™××ª ×™×¢×“×™× (×¢×™×¨, ××“×™× ×”, ××˜×‘×¢, ××—×™×¨ ××™× ×™××•×) ×œ×›×œ ×”×™×¢×“×™× ×‘-DB,
    ×›×•×œ×œ ×™×¢×“×™× ×™×©× ×™×, ×œ×¤×™ ×”×¡×›×™××” ×”×¢×©×™×¨×” ×©×œ flights (dest_city, dest_country, price, currency).
    """
    return logic.list_destinations(conn)

def _format_dest_label(city: str, country: str, cur: str, min_price: Optional[float], picked: bool) -> str:
    # ×©× ×§×¦×¨ ×•×§×¨×™×
    name = f"{city} Â· {country}".strip(" Â·")
    if len(name) > 18:
        name = name[:17] + "â€¦"
    price = f"{cur}{int(min_price)}" if (min_price and cur) else (cur or "")
    label = name if not price else f"{price}  Â·  {name}"
    if picked:
        label += " âœ…"
    return label

def _build_dest_block(conn, selected: Set[str]) -> InlineKeyboardMarkup:
    rows = _fetch_dest_rows(conn)
    buttons: List[InlineKeyboardButton] = []

    # ×›×¤×ª×•×¨ â€œ×›×œ ×”×™×¢×“×™×â€
    all_picked = "__ALL__" in selected
    all_label = "×›×œ ×”×™×¢×“×™× ğŸŒ" + (" âœ…" if all_picked else "")
    buttons.append(InlineKeyboardButton(all_label, callback_data="dst:ALL"))

    # ×©××¨ ×”×™×¢×“×™×
    for city, country, cur, min_price in rows:
        key = f"{city}|{country}"
        picked = all_picked or (key in selected)
        label = _format_dest_label(city or "", country or "", cur or "", min_price, picked)
        buttons.append(InlineKeyboardButton(label, callback_data=f"dst:{key}"))

    # 2 ×¢××•×“×•×ª
    keyboard: List[List[InlineKeyboardButton]] = []
    # ×¨××©×™×ª ×©×•×¨×” ×¢×‘×•×¨ "×›×œ ×”×™×¢×“×™×" ×‘×œ×‘×“
    keyboard.append([buttons[0]])
    # ×œ××—×¨ ××›×Ÿ ×©××¨ ×”×™×¢×“×™× ×‘×©×ª×™ ×¢××•×“×•×ª
    col = []
    for b in buttons[1:]:
        col.append(b)
        if len(col) == 2:
            keyboard.append(col)
            col = []
    if col:
        keyboard.append(col)

    # ×©×•×¨×ª ×‘×§×¨×” ×ª×—×ª×•× ×” (× ×©××™×¨ ×¨×§ ×¨×¢× ×•×Ÿ ×›×¨×’×¢)
    keyboard.append([
        InlineKeyboardButton("ğŸ”„ ×¨×¢× ×•×Ÿ", callback_data="refresh"),
        InlineKeyboardButton("ğŸ“Š ×¡×™×›×•× ×™×¢×“×™×", callback_data="summary"),
    ])

    return InlineKeyboardMarkup(keyboard)

# =========================
# ××¡×š ×¨××©×™
# =========================
def _build_main_screen(conn, selected: Set[str]) -> tuple[str, InlineKeyboardMarkup]:
    # ×¨×§ ×‘×¨×›×” ×‘×©×•×¨×” ×”×¢×œ×™×•× ×” (×œ×¤×™ ×“×¨×™×©×ª×š)
    # ×”×’×¨×¡×” × ×œ×§×—×ª ×-logic.get_version() ×›×“×™ ×œ× ×œ×’×¢×ª ×‘×§×‘×¦×™× ××—×¨×™×
    greet = _greeting_line(version=logic.get_version())
    text = greet
    km = _build_dest_block(conn, selected)
    return text, km

# =========================
# Handlers
# =========================
async def handle_start(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    # ×”×©×’/××ª×—×œ ××¦×‘ ×‘×—×™×¨×” ×œ××©×ª××©
    selected: Set[str] = set(context.user_data.get(UKEY_SELECTED_DESTS, set()))
    conn = db.get_conn()
    text, km = _build_main_screen(conn, selected)
    await update.effective_message.reply_text(text, reply_markup=km)

async def handle_callback(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    q = update.callback_query
    await q.answer()
    data = (q.data or "").strip()
    conn = db.get_conn()

    selected: Set[str] = set(context.user_data.get(UKEY_SELECTED_DESTS, set()))

    if data == "refresh" or data == "home":
        text, km = _build_main_screen(conn, selected)
        old_text = q.message.text or ""
        old_km = q.message.reply_markup
        if old_text == text and str(old_km) == str(km):
            text += "\u2063"
        await q.edit_message_text(text, reply_markup=km)
        return

    if data == "summary":
        # ×¡×™×›×•× ×™×¢×“×™× ×œ×¤×™ ×“×¨×™×©×” ×¢×ª×™×“×™×ª â€“ ×›×¨×’×¢ ×¨×§ ××¦×™×™×Ÿ ×›××” × ×‘×—×¨×•
        count = len(selected) if "__ALL__" not in selected else "×”×›×•×œ"
        text = f"ğŸ“Š ×¡×™×›×•× ×–×× ×™: ×‘×—×™×¨×ª ×™×¢×“×™× = {count}."
        km = _build_dest_block(conn, selected)
        old_text = q.message.text or ""
        old_km = q.message.reply_markup
        if old_text == text and str(old_km) == str(km):
            text += "\u2063"
        await q.edit_message_text(text, reply_markup=km)
        return

    if data.startswith("dst:"):
        target = data[4:]
        if target == "ALL":
            # Toggle ××œ/"××›×œ"
            if "__ALL__" in selected:
                selected.discard("__ALL__")
            else:
                selected.clear()
                selected.add("__ALL__")
        else:
            if "__ALL__" in selected:
                # ×× × ×‘×—×¨ "×›×œ ×”×™×¢×“×™×" ×•×”××©×ª××© ×‘×—×¨ ×™×¢×“ ×™×“× ×™ â€“ × ×‘×˜×œ "ALL" ×•× ×¢×‘×•×¨ ×œ×¡×™××•×Ÿ ×¤×¨×˜× ×™
                selected.discard("__ALL__")
            if target in selected:
                selected.discard(target)
            else:
                selected.add(target)

        # ×©××™×¨×ª ×”××¦×‘ ×œ××©×ª××©
        context.user_data[UKEY_SELECTED_DESTS] = selected

        # ×¨×¢× ×•×Ÿ ××¡×š
        text, km = _build_main_screen(conn, selected)
        old_text = q.message.text or ""
        old_km = q.message.reply_markup
        if old_text == text and str(old_km) == str(km):
            text += "\u2063"
        await q.edit_message_text(text, reply_markup=km)
        return

    # ×‘×¨×™×¨×ª ××—×“×œ â€“ ×—×–×¨×” ×œ××¡×š
    text, km = _build_main_screen(conn, selected)
    old_text = q.message.text or ""
    old_km = q.message.reply_markup
    if old_text == text and str(old_km) == str(km):
        text += "\u2063"
    await q.edit_message_text(text, reply_markup=km)
